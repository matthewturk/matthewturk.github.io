<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.8.0"><meta name=author content="Matthew Turk"><meta name=description content="A project I&rsquo;ve been noodling with for the last few years (okay a lot of years) has been reverse engineering the file formats for the game The Summoning. This has led to things like learning kaitai."><link rel=alternate hreflang=en-us href=https://matthewturk.github.io/post/how-i-rang-in-2024/><meta name=theme-color content="#EF525B"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"><link rel=stylesheet href=/css/academic.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-141183895-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}function trackOutboundLink(e,t){gtag("event","click",{event_category:"outbound",event_label:e,transport_type:"beacon",event_callback:function(){t!=="_blank"&&(document.location=e)}}),console.debug("Outbound link clicked: "+e)}function onClickCallback(e){if(e.target.tagName!=="A"||e.target.host===window.location.host)return;trackOutboundLink(e.target,e.target.getAttribute("target"))}gtag("js",new Date),gtag("config","UA-141183895-1",{anonymize_ip:!0}),document.addEventListener("click",onClickCallback,!1)</script><link rel=manifest href=/index.webmanifest><link rel=icon type=image/png href=/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png><link rel=canonical href=https://matthewturk.github.io/post/how-i-rang-in-2024/><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@powersoffour"><meta property="twitter:creator" content="@powersoffour"><meta property="og:site_name" content="mjt"><meta property="og:url" content="https://matthewturk.github.io/post/how-i-rang-in-2024/"><meta property="og:title" content="How I Rang In 2024 | mjt"><meta property="og:description" content="A project I&rsquo;ve been noodling with for the last few years (okay a lot of years) has been reverse engineering the file formats for the game The Summoning. This has led to things like learning kaitai."><meta property="og:image" content="https://matthewturk.github.io/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png"><meta property="twitter:image" content="https://matthewturk.github.io/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2024-01-03T13:00:00-05:00"><meta property="article:modified_time" content="2024-01-03T16:33:38-06:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://matthewturk.github.io/post/how-i-rang-in-2024/"},"headline":"How I Rang In 2024","datePublished":"2024-01-03T13:00:00-05:00","dateModified":"2024-01-03T16:33:38-06:00","author":{"@type":"Person","name":"Matthew Turk"},"publisher":{"@type":"Organization","name":"mjt","logo":{"@type":"ImageObject","url":"https://matthewturk.github.io/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png"}},"description":"A project I\u0026rsquo;ve been noodling with for the last few years (okay a lot of years) has been reverse engineering the file formats for the game The Summoning. This has led to things like learning kaitai."}</script><script src=https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.js integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.css integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin=anonymous><script>window.addEventListener("load",function(){window.cookieconsent.initialise({palette:{popup:{background:"#EF525B",text:"#EAE7D6"},button:{background:"#EAE7D6",text:"#EF525B"}},theme:"classic",content:{message:"This website uses cookies to ensure you get the best experience on our website.",dismiss:"Got it!",link:"Learn more",href:"https://www.cookiesandyou.com"}})})</script><title>How I Rang In 2024 | mjt</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>mjt</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>mjt</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/#courses><span>Courses</span></a></li><li class=nav-item><a class=nav-link href=/#talks><span>Talks</span></a></li><li class=nav-item><a class=nav-link href=/#publications><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/#contact><span>Contact</span></a></li><li class=nav-item><a class=nav-link href=https://data-exp-lab.github.io/ target=_blank rel=noopener><span>Research Group</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li></ul></div></nav><article class=article><div class="article-container pt-3"><h1>How I Rang In 2024</h1><p class=page-subtitle>or, copy protection from 1992</p><div class=article-metadata><span class=article-date>Last updated on
Jan 3, 2024</span></div></div><div class=article-container><div class=article-style><p>A project I&rsquo;ve been noodling with for the last few years (okay a lot of years) has been reverse engineering the file formats for the game
<a href=https://en.wikipedia.org/wiki/The_Summoning_%28video_game%29 target=_blank rel=noopener>The Summoning</a>. This has led to things like learning
<a href=https://kaitai.io target=_blank rel=noopener>kaitai.io</a>, digging into
<a href=https://github.com/matthewturk/jupyterlab_dosbox target=_blank rel=noopener>DOSbox</a>,
<a href=https://ghidra-sre.org/ target=_blank rel=noopener>Ghidra</a> (and writing
<a href=https://github.com/matthewturk/ghidra-msdos-syscalls target=_blank rel=noopener>some scripts</a>), and exploring lots of things in a
<a href=https://github.com/matthewturk/dispersing/ target=_blank rel=noopener>parsing library</a>. I even
<a href="https://www.youtube.com/watch?v=2v5CBW3yGi0" target=_blank rel=noopener>live streamed</a> some reversing work and a walkthrough of my efforts a while back.</p><p>I played this game as a kid. It came out in 1992, and my grandfather bought it for us. It&rsquo;s &mldr; long. Like, really, really, <em>really</em> long. And there&rsquo;s a plot! With NPCs! (In fact, the person who designed the plot now runs a rather awesome
<a href=https://dreamforgemagazine.com/ target=_blank rel=noopener>Science Fiction Magazine</a>) But it&rsquo;s also kind of &mldr; grindy?</p><p>Anyway, it has its fans online, although the spiritual sequel
<a href=https://en.wikipedia.org/wiki/Veil_of_Darkness target=_blank rel=noopener>Veil of Darkness</a> seems to be an awful lot more popular;
<a href=https://davidlcraddock.com/ target=_blank rel=noopener>David L. Craddock</a> even did an oral history of it which he included in the book <em>Game Dev Stories 5</em>, which seems to be rather tricky to get ahold of lately. (I snagged it in a
<a href=https://storybundle.com/books/3182 target=_blank rel=noopener>Storybundle</a>).</p><p>Both The Summoning and Veil of Darkness have recently been released on
<a href=https://gog.com target=_blank rel=noopener>GOG</a> and
<a href=https://steampowered.com/ target=_blank rel=noopener>Steam</a>.</p><p>There are still lots of mysteries for the code to give up, but I find it absolutely fascinating to dig in and learn about the different ways that the developers did things. Honestly, it&rsquo;s just incredible to be able to appreciate the craft of their work &ndash; and seeing how they saved space in some ways, how they used swap files, and learn about how they operated within the confines of the MS-DOS era. I&rsquo;ve been tempted a few times to try to reach out to one or more of them, but have always been a bit too afraid to.</p><p>One of the biggest mysteries &ndash; which I am certain has been discovered by others, but which I did not &ndash; was how the game&rsquo;s copy protection worked. When you start the game, it shows a screen like this:</p><p><img src=summoning-page49-copyprotection.png alt></p><p>(In this case though I&rsquo;ve put the first four faces in already.) My assumption had <em>always</em> been that the <em>correct</em> ordering of the faces was stored somewhere in either the executable or in one of the affiliated data files, likely in an obfuscated fashion. But finding out precisely where they were &mldr; that had eluded me.</p><p><strong>UNTIL NOW!</strong></p><p>(Using that phrasing is a joke that only hard-core TheSummoning-heads will get. Haha, right?)</p><p>I recently took the time to implement a script that converted references in Ghidra to segmented memory references, defaulting to pointing at the local <code>DS</code> section. (Of course I don&rsquo;t automate all of it &ndash; I hardcode the <code>DS</code>!) This really helped me understand where strings were used. And shortly after this, I was able to finally understand how the string formatting function worked, and so I found myself knowing where the string &ldquo;Please turn to page&rdquo; was being fed in, and the number that arrived just after it &ndash; the page number. With a bit of work, I dug deeper and found a function that Ghidra decompiled into:</p><pre><code class=language-c>  iVar1 = page_number + 1;
  iVar2 = iVar1;
  for (iVar4 = 1; iVar4 &lt; 6; iVar4 = iVar4 + 1) {
    iVar2 = (iVar4 + page_number) % 5;
    iVar3 = (iVar1 * iVar2 * iVar2 * iVar2 + iVar2 * 0x45 + iVar1 * 0x2f) % 0x8b;
    iVar2 = iVar3 / 0xc;
    *(int *)((int)&amp;DAT_235b_44ec + (iVar4 + -1) * 2) = iVar3 % 0xc;
  }
  return iVar2;
</code></pre><p>Huh. This was where things got interesting. I had assumed that if things had been procedurally generated, at least one of the numbers that showed up would be the number of pages in the manual or something like that. But this &mldr; was not featuring any of those.</p><p>And yet.</p><p>One of the difficult things for me is understanding how the graphics are done. I&rsquo;m still learning, but I believe the software uses software interrupt 60 to signal that sprites or text or other things are ready to be written to the screen. (Maybe.) But where they were stored in memory was tricky, and so I was not entirely sure that I understood precisely where to look for memory accesses to see where the drawing would take place.</p><p>What grabbed my attention here was the <code>0xc</code>. I&rsquo;m not the kind of person who can effortlessly convert back and forth to hex, but I recognized that as 12 &ndash; the same as the number of faces we have to choose from. And also, it only has one parameter &ndash; the page number.</p><p>I coded this up in Python:</p><pre><code class=language-python>vals = {}
for page_i in range(15):
    vals[page_i] = []
    iVar1 = page_i + 1
    ivar2 = iVar1
    for iVar4 in range(1, 6):
        iVar2 = (iVar4 + page_i) % 5
        iVar3 = (iVar1 * iVar2 * iVar2 * iVar2 + iVar2 * 0x45 + iVar1 * 0x2f) % 0x8b
        iVar2 = iVar3 / 0xc
        vals[page_i].append(iVar3 % 0xc)
    print(f&quot;{page_i: 2d}: {vals[page_i]}&quot;)
</code></pre><p>(I want to note that I left almost everything exactly as-is, rather than potentially introduce any bugs from accidental errors like reducing a factor incorrectly.) Here is the output:</p><pre><code> 0: [9, 6, 3, 1, 11]
 1: [1, 5, 9, 10, 2]
 2: [0, 5, 2, 2, 1]
 3: [1, 1, 2, 8, 2]
 4: [0, 7, 3, 9, 4]
 5: [7, 3, 11, 0, 4]
</code></pre><p>Even though I didn&rsquo;t have a mapping from the integer to the face, comparing it to the first six pages from the manual made it immediately clear &ndash; this was it.</p><p><img src=summoning-first6pages-copyprotection.png alt></p><p>I know this is not a huge deal, in the grand scheme of things. I&rsquo;m sure many people have figured this out before me. But to tell the truth, this was a really fun and gratifying thing to figure out, and I am pretty glad I was able to ring in the new year with it.</p></div><div class="media author-card content-widget-hr"><img class="avatar mr-3 avatar-circle" src="https://s.gravatar.com/avatar/b279d746f54e2cd6062e8279a767c4bc?s=200')" alt="Matthew Turk"><div class=media-body><h5 class=card-title><a href=https://matthewturk.github.io/>Matthew Turk</a></h5><h6 class=card-subtitle>Assistant Professor of Information Sciences</h6><p class=card-text>I am interested in the intersection of data analysis, visualization and open source in the sciences.</p><ul class=network-icon aria-hidden=true><li><a href=mailto:matthewturk@gmail.com><i class="fas fa-envelope"></i></a></li><li><a href=https://twitter.com/powersoffour target=_blank rel=noopener><i class="fab fa-twitter"></i></a></li><li><a href="https://scholar.google.com/citations?user=QTmv2p0AAAAJ&amp;hl=en" target=_blank rel=noopener><i class="ai ai-google-scholar"></i></a></li><li><a href=https://github.com/matthewturk target=_blank rel=noopener><i class="fab fa-github"></i></a></li></ul></div></div></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/python.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin=anonymous></script>
<script>const code_highlighting=!0</script><script>const isSiteThemeDark=!1</script><script>const search_config={indexURI:"/index.json",minLength:1,threshold:.3},i18n={no_results:"No results found",placeholder:"Search...",results:"results found"},content_type={post:"Posts",project:"Projects",publication:"Publications",talk:"Talks",slides:"Slides"}</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script>
<script src=/js/academic.min.cd45a9c0bbdd3dfb1c126917c601c9f2.js></script><div class=container><footer class=site-footer><p class=powered-by></p><p class=powered-by>Powered by the
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic theme</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.
<span class=float-right aria-hidden=true><a href=# class=back-to-top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div></body></html>