<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.8.0"><meta name=author content="Matthew Turk"><meta name=description content="I think I&rsquo;ve talked myself into proposing a big change in yt. I&rsquo;m not the &ldquo;boss&rdquo; of yt, so it might not happen, but I&rsquo;ve kind of worked up my courage to make a serious suggestion."><link rel=alternate hreflang=en-us href=https://matthewturk.github.io/post/yt-internal-and-external-ecosystems/><meta name=theme-color content="#EF525B"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script>
<link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"><link rel=stylesheet href=/css/academic.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-141183895-1"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}function trackOutboundLink(e,t){gtag("event","click",{event_category:"outbound",event_label:e,transport_type:"beacon",event_callback:function(){t!=="_blank"&&(document.location=e)}}),console.debug("Outbound link clicked: "+e)}function onClickCallback(e){if(e.target.tagName!=="A"||e.target.host===window.location.host)return;trackOutboundLink(e.target,e.target.getAttribute("target"))}gtag("js",new Date),gtag("config","UA-141183895-1",{anonymize_ip:!0}),document.addEventListener("click",onClickCallback,!1)</script><link rel=manifest href=/index.webmanifest><link rel=icon type=image/png href=/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_3.png><link rel=apple-touch-icon type=image/png href=/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png><link rel=canonical href=https://matthewturk.github.io/post/yt-internal-and-external-ecosystems/><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@powersoffour"><meta property="twitter:creator" content="@powersoffour"><meta property="og:site_name" content="mjt"><meta property="og:url" content="https://matthewturk.github.io/post/yt-internal-and-external-ecosystems/"><meta property="og:title" content="yt: Internal and External Ecosystems | mjt"><meta property="og:description" content="I think I&rsquo;ve talked myself into proposing a big change in yt. I&rsquo;m not the &ldquo;boss&rdquo; of yt, so it might not happen, but I&rsquo;ve kind of worked up my courage to make a serious suggestion."><meta property="og:image" content="https://matthewturk.github.io/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png"><meta property="twitter:image" content="https://matthewturk.github.io/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_3.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2019-07-16T14:28:36-05:00"><meta property="article:modified_time" content="2019-07-16T14:31:52-05:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://matthewturk.github.io/post/yt-internal-and-external-ecosystems/"},"headline":"yt: Internal and External Ecosystems","datePublished":"2019-07-16T14:28:36-05:00","dateModified":"2019-07-16T14:31:52-05:00","author":{"@type":"Person","name":"Matthew Turk"},"publisher":{"@type":"Organization","name":"mjt","logo":{"@type":"ImageObject","url":"https://matthewturk.github.io/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_3.png"}},"description":"I think I\u0026rsquo;ve talked myself into proposing a big change in yt. I\u0026rsquo;m not the \u0026ldquo;boss\u0026rdquo; of yt, so it might not happen, but I\u0026rsquo;ve kind of worked up my courage to make a serious suggestion."}</script><script src=https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.js integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin=anonymous></script>
<link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.css integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin=anonymous><script>window.addEventListener("load",function(){window.cookieconsent.initialise({palette:{popup:{background:"#EF525B",text:"#EAE7D6"},button:{background:"#EAE7D6",text:"#EF525B"}},theme:"classic",content:{message:"This website uses cookies to ensure you get the best experience on our website.",dismiss:"Got it!",link:"Learn more",href:"https://www.cookiesandyou.com"}})})</script><title>yt: Internal and External Ecosystems | mjt</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>mjt</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>mjt</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/#courses><span>Courses</span></a></li><li class=nav-item><a class=nav-link href=/#talks><span>Talks</span></a></li><li class=nav-item><a class=nav-link href=/#publications><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/#contact><span>Contact</span></a></li><li class=nav-item><a class=nav-link href=https://data-exp-lab.github.io/ target=_blank rel=noopener><span>Research Group</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li></ul></div></nav><article class=article><div class="article-container pt-3"><h1>yt: Internal and External Ecosystems</h1><div class=article-metadata><span class=article-date>Last updated on
Jul 16, 2019</span></div></div><div class=article-container><div class=article-style><p>I think I&rsquo;ve talked myself into proposing a big change in yt. I&rsquo;m not the &ldquo;boss&rdquo; of yt, so it might not happen, but I&rsquo;ve kind of worked up my courage to make a serious suggestion.</p><p>This last week I have been at
<a href=https://scipy2019.scipy.org/ target=_blank rel=noopener>SciPy 2019</a> and I had the opportunity to see a lot of talks.</p><p>There were a few that really stuck with me, but for the purposes of this rather technically-focused blog post, I&rsquo;m going to stick to just one in particular.</p><p><a href=http://matthewrocklin.com/ target=_blank rel=noopener>Matt Rocklin</a> gave a talk about
<a href="https://www.youtube.com/watch?v=Q0DsdiY-jiw" target=_blank rel=noopener>refactoring the ecosystem to prepare for heterogeneous computing</a> (you should go watch it!). More specifically, though, what it seemed to me was that it was a talk more about an opportunity to avoid fragmentation and think more carefully about how arrays and APIs are thought of and used. That got me thinking about something I&rsquo;ve kind of touched on in previous posts (
<a href=https://matthewturk.github.io/post/refactoring-yt-frontends-part1/ target=_blank rel=noopener>here</a>,
<a href=https://matthewturk.github.io/post/refactoring-yt-frontends-part2/ target=_blank rel=noopener>here</a> and
<a href=https://matthewturk.github.io/post/refactoring-yt-frontends-part3/ target=_blank rel=noopener>here</a>) &ndash; basically, that yt is pretty monolithic, and that&rsquo;s not really the best way to evolve with the ecosystem.</p><p>I&rsquo;ll be using
<a href=https://github.com/mgedmin/findimports target=_blank rel=noopener>findimports</a> for exploring how monolithic it <em>is</em> versus how monolithic it <em>appears to be</em>. Basically, I want to see: is it one repo with lots of interconnections, or is it essentially a couple repos?</p><p>(Also at the end I&rsquo;ll give a pitch for why this is relevant, so if you&rsquo;re even remotely intrigued, at <em>least</em> scroll down to the section labeled &ldquo;OK, the boring stuff is over.&rdquo;)</p><pre><code class=language-python>import pickle
import findimports
yt_imports = pickle.load(open(&quot;yt/yt/import_output.pkl&quot;, &quot;rb&quot;))
</code></pre><p>The structure of this is a set of keys that are strings of the filename/modulename, with values that are the objects in question. The <code>findimports</code> objects have an attribute <code>imports</code> which is what we&rsquo;re going to look at first, but they also have an <code>imported_names</code> attribute which is the list of names that get imported, in the form of <code>ImportInfo</code> objects. These have <code>name</code>, <code>filename</code>, <code>level</code> and <code>lineno</code> to show where and what they are.</p><pre><code class=language-python>yt_imports['yt.visualization.plot_window'].imports
</code></pre><pre><code>{'collections',
 'distutils.version',
 'matplotlib',
 'matplotlib.mathtext',
 'matplotlib.ticker',
 'numbers',
 'numpy',
 'pyparsing',
 'sys',
 'types',
 'unyt.exceptions',
 'yt',
 'yt.data_objects.image_array',
 'yt.frontends.ytdata.data_structures',
 'yt.funcs',
 'yt.units.unit_object',
 'yt.units.unit_registry',
 'yt.units.yt_array',
 'yt.utilities.exceptions',
 'yt.utilities.math_utils',
 'yt.utilities.orientation',
 'yt.visualization.base_plot_types',
 'yt.visualization.fixed_resolution',
 'yt.visualization.geo_plot_utils',
 'yt.visualization.plot_container',
 'yt.visualization.plot_modifications'}
</code></pre><p>There happen to be a fair number of things in here that are external to yt! So, let&rsquo;s set up a filtering process for those. We&rsquo;ll filter the <code>name</code> that is imported.</p><p>One thing I should note is that yt does many, but not <em>all</em>, of its imports in absolute form, which maybe isn&rsquo;t &mldr; so great &mldr; but which lets us do this more easily.</p><pre><code class=language-python>filter_imports = lambda a: [_ for _ in sorted(a, key=lambda b: b.name) if _.name.startswith(&quot;yt.&quot;)]
</code></pre><p>We&rsquo;ll apply it to the <code>imported_names</code> attribute, since we&rsquo;re interested in characterizing how things are related and interweaved.</p><pre><code class=language-python>import_lists = {_ : filter_imports(yt_imports[_].imported_names) for _ in yt_imports}
</code></pre><pre><code class=language-python>import_lists['yt.visualization.plot_window']
</code></pre><pre><code>[ImportInfo('yt.data_objects.image_array.ImageArray', 'yt/visualization/plot_window.py', 40, 0),
 ImportInfo('yt.frontends.ytdata.data_structures.YTSpatialPlotDataset', 'yt/visualization/plot_window.py', 42, 0),
 ImportInfo('yt.funcs.ensure_list', 'yt/visualization/plot_window.py', 44, 0),
 ImportInfo('yt.funcs.fix_axis', 'yt/visualization/plot_window.py', 45, 0),
 ImportInfo('yt.funcs.fix_unitary', 'yt/visualization/plot_window.py', 45, 0),
 ImportInfo('yt.funcs.iterable', 'yt/visualization/plot_window.py', 44, 0),
 ImportInfo('yt.funcs.mylog', 'yt/visualization/plot_window.py', 44, 0),
 ImportInfo('yt.funcs.obj_length', 'yt/visualization/plot_window.py', 45, 0),
 ImportInfo('yt.load', 'yt/visualization/plot_window.py', 737, 0),
 ImportInfo('yt.load', 'yt/visualization/plot_window.py', 1373, 0),
 ImportInfo('yt.load', 'yt/visualization/plot_window.py', 1557, 0),
 ImportInfo('yt.load', 'yt/visualization/plot_window.py', 2067, 0),
 ImportInfo('yt.units.unit_object.Unit', 'yt/visualization/plot_window.py', 47, 0),
 ImportInfo('yt.units.unit_registry.UnitParseError', 'yt/visualization/plot_window.py', 49, 0),
 ImportInfo('yt.units.yt_array.YTArray', 'yt/visualization/plot_window.py', 51, 0),
 ImportInfo('yt.units.yt_array.YTQuantity', 'yt/visualization/plot_window.py', 51, 0),
 ImportInfo('yt.utilities.exceptions.YTCannotParseUnitDisplayName', 'yt/visualization/plot_window.py', 57, 0),
 ImportInfo('yt.utilities.exceptions.YTDataTypeUnsupported', 'yt/visualization/plot_window.py', 59, 0),
 ImportInfo('yt.utilities.exceptions.YTInvalidFieldType', 'yt/visualization/plot_window.py', 60, 0),
 ImportInfo('yt.utilities.exceptions.YTPlotCallbackError', 'yt/visualization/plot_window.py', 58, 0),
 ImportInfo('yt.utilities.exceptions.YTUnitNotRecognized', 'yt/visualization/plot_window.py', 61, 0),
 ImportInfo('yt.utilities.math_utils.ortho_find', 'yt/visualization/plot_window.py', 53, 0),
 ImportInfo('yt.utilities.orientation.Orientation', 'yt/visualization/plot_window.py', 55, 0)]
</code></pre><p>This still isn&rsquo;t <em>incredibly</em> useful, since we kind of want to look at imports at a higher level. For instance, I want to know what <code>yt.visualization.plot_window</code> imports from in the broad cross-section of the code base. So let&rsquo;s write something to collapse the package <em>under</em> yt that we import from. We used <code>startswith(".yt")</code> earlier, so it&rsquo;ll be safe to do a split here.</p><pre><code class=language-python>collapse_subpackage = lambda a: set(_.name.split(&quot;.&quot;)[1] for _ in a)
</code></pre><pre><code class=language-python>collapse_subpackage(import_lists['yt.visualization.plot_window'])
</code></pre><pre><code>{'data_objects', 'frontends', 'funcs', 'load', 'units', 'utilities'}
</code></pre><p>Interesting. We import from frontends?! I guess I kind of missed that earlier. Let&rsquo;s see if we can figure out the connections between different modules to see if anything stands out.</p><pre><code class=language-python>from collections import defaultdict
</code></pre><pre><code class=language-python>subpackage_imports = defaultdict(set)
for fn, v in import_lists.items():
    if not fn.startswith(&quot;yt.&quot;): continue # Get rid of our tests, etc.
    subpackage = fn.split(&quot;.&quot;)[1]
    subpackage_imports[subpackage].update(collapse_subpackage(v))
</code></pre><p>Let&rsquo;s break this down before we go any further &ndash; for starters, not <em>everything</em> is an absolute import. So that makes things a bit tricky! But we can deal with that later. Let&rsquo;s first see what all we have:</p><pre><code class=language-python>subpackage_imports.keys()
</code></pre><pre><code>dict_keys(['__init__', 'api', 'arraytypes', 'config', 'convenience', 'exthook', 'funcs', 'mods', 'pmods', 'startup_tasks', 'testing', 'analysis_modules', 'data_objects', 'extensions', 'extern', 'fields', 'frontends', 'geometry', 'tests', 'units', 'utilities', 'visualization'])
</code></pre><p>A few things stand out right away. Some of these we can immediately get rid of and not consider. For instance, <code>pmods</code> is an MPI-aware importer, <code>mods</code> is a pretty old-school approach to yt importing, and we will just ignore <code>testing</code>, <code>analysis_modules</code>, <code>extensions</code> and <code>extern</code> since they&rsquo;re (in order) testing utilities, gone, a fake hook system, and &ldquo;vendored&rdquo; libraries that we should probably get rid of and just make requirements anyway. <code>units</code> is now part of
<a href=https://github.com/yt-project/unyt target=_blank rel=noopener><code>unyt</code></a> and some of the others are by-design grabbing lots of stuff.</p><pre><code class=language-python>blacklist = [&quot;testing&quot;, &quot;analysis_modules&quot;, &quot;extensions&quot;, &quot;extern&quot;, &quot;pmods&quot;,
             &quot;mods&quot;, &quot;__init__&quot;, &quot;api&quot;, &quot;arraytypes&quot;, &quot;config&quot;, &quot;convenience&quot;,
            &quot;exthook&quot;, &quot;funcs&quot;, &quot;tests&quot;, &quot;units&quot;, &quot;startup_tasks&quot;]

list(subpackage_imports.pop(_, None) for _ in blacklist);
</code></pre><p>We just want to see the interrelationships, so we&rsquo;ll look for N-by-N collisions, where N is just the values that show up as keys.</p><pre><code class=language-python>collide_with = set(subpackage_imports.keys())
</code></pre><pre><code class=language-python>collisions = {_: collide_with.intersection(subpackage_imports[_]) for _ in subpackage_imports}
</code></pre><p>And here we have it, the moment of truth! What do we see &mldr;</p><pre><code class=language-python>print({_:len(__) for _, __ in collisions.items()})
</code></pre><pre><code>{'data_objects': 6, 'fields': 5, 'frontends': 6, 'geometry': 5, 'utilities': 6, 'visualization': 6}
</code></pre><p>Huh. Well, that was not the dramatic, amazing reveal I&rsquo;d hoped for.</p><pre><code class=language-python>subpackage_imports = defaultdict(set)
for fn, v in import_lists.items():
    if not fn.startswith(&quot;yt.&quot;) or &quot;tests&quot; in fn: continue # Get rid of our tests, etc.
    subpackage = fn.split(&quot;.&quot;)[1]
    subpackage_imports[subpackage].update(collapse_subpackage(v))
list(subpackage_imports.pop(_, None) for _ in blacklist);
collisions = {_: collide_with.intersection(subpackage_imports[_]) for _ in subpackage_imports}
print({_:len(__) for _, __ in collisions.items()})
</code></pre><pre><code>{'data_objects': 6, 'fields': 4, 'frontends': 6, 'geometry': 4, 'utilities': 5, 'visualization': 6}
</code></pre><p>It gets a little bit better, but honestly, not much. Our most isolated package &ndash; by this (likely flawed) method &ndash; are the <code>geometry</code> and <code>fields</code> packages. So let&rsquo;s break down a bit more what we&rsquo;re seeing, by not filtering quite as much, and by setting up a reverse mapping. And let&rsquo;s do it for both the collapsed name and the non-collapsed name.</p><pre><code class=language-python>subpackage_imports = defaultdict(set)
imported_by = defaultdict(list)
for fn, v in import_lists.items():
    if not fn.startswith(&quot;yt.&quot;) or &quot;tests&quot; in fn: continue # Get rid of our tests, etc.
    subpackage = fn.split(&quot;.&quot;)[1]
    subpackage_imports[subpackage].update(set(_.name for _ in v))
    [imported_by[_.name].append(fn) for _ in v]
    [imported_by[_].append(fn) for _ in collapse_subpackage(v)]
</code></pre><p>And now we might be getting somewhere. So now we can look up for any given import which files have imported it. Let&rsquo;s see what imports the progress bar:</p><pre><code class=language-python>imported_by[&quot;yt.funcs.get_pbar&quot;]
</code></pre><pre><code>['yt.__init__',
 'yt.data_objects.particle_trajectories',
 'yt.data_objects.level_sets.contour_finder',
 'yt.frontends.athena_pp.data_structures',
 'yt.frontends.enzo.data_structures',
 'yt.frontends.enzo_p.data_structures',
 'yt.geometry.particle_geometry_handler',
 'yt.utilities.minimal_representation',
 'yt.utilities.particle_generator',
 'yt.utilities.answer_testing.framework',
 'yt.visualization.streamlines',
 'yt.visualization.volume_rendering.old_camera']
</code></pre><p>Nice. Now, let&rsquo;s look at visualization.</p><pre><code class=language-python>imported_by[&quot;yt.visualization.api.SlicePlot&quot;], imported_by[&quot;yt.visualization.plot_window.SlicePlot&quot;]
</code></pre><pre><code>(['yt.__init__', 'yt.data_objects.analyzer_objects'],
 ['yt.utilities.command_line'])
</code></pre><p>We&rsquo;re starting to see that things might not be quite as clear-cut as we thought. Let&rsquo;s look at geometry. And I&rsquo;m going to set up a filtering method so that we can avoid lots of redundant pieces of info &ndash; for instance, I don&rsquo;t care about things importing themselves.</p><pre><code class=language-python>filter_self_imports = lambda a: [_ for _ in imported_by[a] if not _.startswith(&quot;yt.{}&quot;.format(a))]
</code></pre><p>We&rsquo;ll only look at the first ten, because it&rsquo;s really long&mldr;</p><pre><code class=language-python>filter_self_imports(&quot;geometry&quot;)[:10]
</code></pre><pre><code>['yt.data_objects.construction_data_containers',
 'yt.data_objects.data_containers',
 'yt.data_objects.grid_patch',
 'yt.data_objects.octree_subset',
 'yt.data_objects.selection_data_containers',
 'yt.data_objects.static_output',
 'yt.data_objects.unstructured_mesh',
 'yt.frontends._skeleton.data_structures',
 'yt.frontends.ahf.data_structures',
 'yt.frontends.art.data_structures']
</code></pre><p>Here things are <em>much</em> clearer. We import geometry <em>once</em> in the visualization subsystem, under <code>plot_modifications</code>. I looked it up, and here&rsquo;s what it is:</p><pre><code class=language-python>if not issubclass(type(index), UnstructuredIndex):
    raise RuntimeError(&quot;Mesh line annotations only work for &quot;
                        &quot;unstructured or semi-structured mesh data.&quot;)
</code></pre><p>This is probably an anti-pattern, but even if we wanted to retain this specific behavior, we could remedy it without too much trouble by having an attribute check, or some kind of string-key check.</p><p>As for all the <code>frontends</code> imports, those are all because they subclass <code>Index</code>! And many of the places importing it in <code>data_objects</code> are just due to a lack of organization in the geometry/utilities/indexing code.</p><p><strong>Historical Sidenote</strong>: As I was doing this, I read the header for <code>grid_patch.py</code> and it reads: <code>"Python-based grid handler, not to be confused with the SWIG-handler"</code>. I am reasonably certain that it has been <em>years</em> since I thought about the proto-SWIG system I&rsquo;d written to wrap around the Enzo C++ code. Kinda supports the point I intend to make when I end this post, I think.</p><p>Back to the task at hand, let&rsquo;s look at some of the other top-level packages and how they related. I&rsquo;m now specifically interested in the <code>visualization</code> and <code>data_objects</code> ones.</p><pre><code class=language-python>filter_self_imports(&quot;visualization&quot;)
</code></pre><pre><code>['yt.__init__',
 'yt.data_objects.analyzer_objects',
 'yt.data_objects.construction_data_containers',
 'yt.data_objects.data_containers',
 'yt.data_objects.image_array',
 'yt.data_objects.profiles',
 'yt.data_objects.region_expression',
 'yt.data_objects.selection_data_containers',
 'yt.frontends.fits.misc',
 'yt.utilities.command_line',
 'yt.utilities.fits_image',
 'yt.utilities.answer_testing.framework']
</code></pre><p>Well, that&rsquo;s interesting. A quick skim of the code suggests that <code>analyzer_objects</code> is probably dead code to be removed, <code>construction_data_containers</code> imports viz so that <code>.plot()</code> will work on projections, and there are a handful of other data-object-to-viz things that get done here.</p><p>In short, I&rsquo;m pretty sure that <code>visualization</code> is a mostly independent subpackage. And the same kind of goes for <code>geometry</code>. The story isn&rsquo;t quite as clear for the others.</p><h2 id=ok-the-boring-stuff-is-over>OK, the boring stuff is over.</h2><p>Here&rsquo;s where I wanted to get this whole time: yt is a monolithic package in packaging, but it also has a couple reasonably independent sub-packages within it. It <em>would</em> be a target for breaking up, <em>if</em> those subpackages were independently useful. But as it stands, they probably aren&rsquo;t, since they&rsquo;re all very tightly coupled.</p><p>They&rsquo;re coupled because they were written that way, without too much thought given to a public, externally-useful API. This is something that&rsquo;s probably not surprising, since yt was a big package that evolved, rather than many packages that interoperated. Lots of stuff we wanted didn&rsquo;t exist, and there was (we thought) really only one obvious way to do things, so why not just do it?</p><p>(<strong>Historical sidenote</strong>: It was a few years ago that I remember asking at a panel what middleware developers, like I saw myself, were supposed to do in a rapidly evolving ecosystem of the array container. (I probably didn&rsquo;t phrase it very well.) What I took away was: stick with numpy. And we did stick with numpy, and more importantly, we <em>stuck with the Cython interface to numpy</em>.)</p><h2 id=ok-no-more-rambling-get-to-the-point>OK, no more rambling, get to the point</h2><p>yt did a lot of stuff on its own. It doesn&rsquo;t need to anymore. It&rsquo;s effectively a medium-ly coupled system, but one that has relied on the ability to change non-public APIs all the time.</p><p>I&rsquo;m starting to convince myself it&rsquo;s time to mature as a project, and to do some combination of <em>jettisoning</em> and <em>liberating</em> things in yt. I&rsquo;ll make it clear that I could be wrong on this, and seeing this through will probably take more thought, time and energy than I can reasonably personally commit, but I think I&rsquo;ve started to see what would be a productive path forward.</p><h1 id=steps-to-integrate-better>Steps to Integrate Better</h1><p>Here are some things that I think yt could do. These are my thoughts, which I have <em>not</em> presented to the steering council, written up in a YTEP, or even made any efforts toward. In fact, the one member of the steering committee to whom I said, &ldquo;I think I might blog about this&rdquo; explicitly suggested I not do that thing (blog)! But here I am a couple pages deep and I&rsquo;ve always been a bit of a hoarder.</p><h3 id=inventory>Inventory</h3><p>The first step would be to take a real inventory of what is in yt, and what ought to be in yt. I have some thoughts on things that could be gotten rid of (and I will happily note that I intend to &ldquo;kill my own darlings&rdquo; first, before anyone else&rsquo;s) but that can come later.</p><p>Not everything yt does needs to be done <em>by yt</em>. But before we can figure that out, let&rsquo;s figure out what yt is doing, and where it gets relied on.</p><h3 id=indexing>Indexing</h3><p>The thing I think we absolutely need to think about is how tightly coupled the indexing system is with everything else. This will almost certainly be a full blog post at a later time, but the way the indexing is coupled so tightly with the frontends makes me increasingly leery.</p><p>I personally think that the way the grid indexing is set up is too fixed on a pre-parsing step and a finalization step, with lots of little bits in between that need to be handled, and that it could much more easily be set up with a different procedure.</p><p>For the particle frontends, the particle bitmap indexing has the filenames and the particle types and the coordinates and <em>all</em> of that all wound together. This should be decoupled, so that the notion of the particle locations is held at a higher level than the bitmap indexing.</p><h3 id=consider-splitting-the-package>Consider Splitting the Package</h3><p>This one &mldr; I want to emphasize that what I think we should do is the process of considering it. I&rsquo;m not sure that it should be split. But I think that evaluating the pros and cons will lead us to think about <em>how</em> our packages interact.</p><p>If two objects call weird methods on each other, why? Does that need to happen? Is it a micro-optimization that makes no sense other than obfuscation? I&rsquo;m not sure, but we can&rsquo;t figure it out unless we examine.</p><h1 id=big-picture>Big Picture</h1><p>yt may stay a big repository, but if we reduce the dependence on artisanal objects (why not just subclass <code>xarray.Dataset</code> instead of have a <code>GridPatch</code> object? Well, okay, that one is pretty complicated, but we can talk about it later&mldr;) and we think about the specifics of why we use public APIs versus private APIs, it can lead to a more robust, lightweight package.</p><p>And anything that keeps us more lightweight, reduces maintenance burdens, and enables us to take advantage of the astounding advances in the ecosystem is probably going to be better in the long-run.</p></div><div class="media author-card content-widget-hr"><img class="avatar mr-3 avatar-circle" src="https://s.gravatar.com/avatar/b279d746f54e2cd6062e8279a767c4bc?s=200')" alt="Matthew Turk"><div class=media-body><h5 class=card-title><a href=https://matthewturk.github.io/>Matthew Turk</a></h5><h6 class=card-subtitle>Assistant Professor of Information Sciences</h6><p class=card-text>I am interested in the intersection of data analysis, visualization and open source in the sciences.</p><ul class=network-icon aria-hidden=true><li><a href=mailto:matthewturk@gmail.com><i class="fas fa-envelope"></i></a></li><li><a href=https://twitter.com/powersoffour target=_blank rel=noopener><i class="fab fa-twitter"></i></a></li><li><a href="https://scholar.google.com/citations?user=QTmv2p0AAAAJ&amp;hl=en" target=_blank rel=noopener><i class="ai ai-google-scholar"></i></a></li><li><a href=https://github.com/matthewturk target=_blank rel=noopener><i class="fab fa-github"></i></a></li></ul></div></div></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/python.min.js></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin=anonymous></script>
<script>const code_highlighting=!0</script><script>const isSiteThemeDark=!1</script><script>const search_config={indexURI:"/index.json",minLength:1,threshold:.3},i18n={no_results:"No results found",placeholder:"Search...",results:"results found"},content_type={post:"Posts",project:"Projects",publication:"Publications",talk:"Talks",slides:"Slides"}</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script>
<script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script>
<script src=/js/academic.min.cd45a9c0bbdd3dfb1c126917c601c9f2.js></script><div class=container><footer class=site-footer><p class=powered-by></p><p class=powered-by>Powered by the
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic theme</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.
<span class=float-right aria-hidden=true><a href=# class=back-to-top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i> Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i> Download</a><div id=modal-error></div></div></div></div></div></body></html>