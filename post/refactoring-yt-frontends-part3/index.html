<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=generator content="Source Themes Academic 4.8.0"><meta name=author content="Matthew Turk"><meta name=description content="Welcome to part 3 of a series on how yt deals with data and the ways that helps and hinders things! This time, I am going to describe what &ldquo;chunks&rdquo; of data (YTDataChunk) in yt are, and a few characteristics of them that wouldn&rsquo;t be obvious from the previous blog posts."><link rel=alternate hreflang=en-us href=https://matthewturk.github.io/post/refactoring-yt-frontends-part3/><meta name=theme-color content="#EF525B"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.8.6/css/academicons.min.css integrity="sha256-uFVgMKfistnJAfoCUQigIl+JfUaP47GrRKjf6CTPVmw=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0-1/css/all.min.css integrity="sha256-4w9DunooKSr3MFXHXWyFER38WmPdm361bQS/2KUWZbU=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin=anonymous><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css crossorigin=anonymous title=hl-light><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css crossorigin=anonymous title=hl-dark disabled><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.css integrity="sha256-SHMGCYmST46SoyGgo4YR/9AlK1vf3ff84Aq9yK4hdqM=" crossorigin=anonymous><script src=https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.1.2/lazysizes.min.js integrity="sha256-Md1qLToewPeKjfAHU1zyPwOutccPAm5tahnaw7Osw0A=" crossorigin=anonymous async></script><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap"><link rel=stylesheet href=/css/academic.css><script async src="https://www.googletagmanager.com/gtag/js?id=UA-141183895-1"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}
function trackOutboundLink(url,target){gtag('event','click',{'event_category':'outbound','event_label':url,'transport_type':'beacon','event_callback':function(){if(target!=='_blank'){document.location=url;}}});console.debug("Outbound link clicked: "+url);}
function onClickCallback(event){if((event.target.tagName!=='A')||(event.target.host===window.location.host)){return;}
trackOutboundLink(event.target,event.target.getAttribute('target'));}
gtag('js',new Date());gtag('config','UA-141183895-1',{'anonymize_ip':true});document.addEventListener('click',onClickCallback,false);</script><link rel=manifest href=/index.webmanifest><link rel=icon type=image/png href=/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_2.png><link rel=apple-touch-icon type=image/png href=/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png><link rel=canonical href=https://matthewturk.github.io/post/refactoring-yt-frontends-part3/><meta property="twitter:card" content="summary"><meta property="twitter:site" content="@powersoffour"><meta property="twitter:creator" content="@powersoffour"><meta property="og:site_name" content="mjt"><meta property="og:url" content="https://matthewturk.github.io/post/refactoring-yt-frontends-part3/"><meta property="og:title" content="Refactoring yt Frontends - Part 3 | mjt"><meta property="og:description" content="Welcome to part 3 of a series on how yt deals with data and the ways that helps and hinders things! This time, I am going to describe what &ldquo;chunks&rdquo; of data (YTDataChunk) in yt are, and a few characteristics of them that wouldn&rsquo;t be obvious from the previous blog posts."><meta property="og:image" content="https://matthewturk.github.io/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_2.png"><meta property="twitter:image" content="https://matthewturk.github.io/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_2.png"><meta property="og:locale" content="en-us"><meta property="article:published_time" content="2019-06-17T22:32:09-04:00"><meta property="article:modified_time" content="2019-06-17T22:38:01-04:00"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://matthewturk.github.io/post/refactoring-yt-frontends-part3/"},"headline":"Refactoring yt Frontends - Part 3","datePublished":"2019-06-17T22:32:09-04:00","dateModified":"2019-06-17T22:38:01-04:00","author":{"@type":"Person","name":"Matthew Turk"},"publisher":{"@type":"Organization","name":"mjt","logo":{"@type":"ImageObject","url":"https://matthewturk.github.io/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png"}},"description":"Welcome to part 3 of a series on how yt deals with data and the ways that helps and hinders things! This time, I am going to describe what \u0026ldquo;chunks\u0026rdquo; of data (YTDataChunk) in yt are, and a few characteristics of them that wouldn\u0026rsquo;t be obvious from the previous blog posts."}</script><script src=https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.js integrity="sha256-5VhCqFam2Cn+yjw61zbBNrbHVJ6SRydPeKopYlngbiQ=" crossorigin=anonymous></script><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.1/cookieconsent.min.css integrity="sha256-zQ0LblD/Af8vOppw18+2anxsuaz3pWYyVWi+bTvTH8Q=" crossorigin=anonymous><script>window.addEventListener("load",function(){window.cookieconsent.initialise({"palette":{"popup":{"background":"#EF525B","text":"#EAE7D6"},"button":{"background":"#EAE7D6","text":"#EF525B"}},"theme":"classic","content":{"message":"This website uses cookies to ensure you get the best experience on our website.","dismiss":"Got it!","link":"Learn more","href":"https://www.cookiesandyou.com"}})});</script><title>Refactoring yt Frontends - Part 3 | mjt</title></head><body id=top data-spy=scroll data-offset=70 data-target=#TableOfContents><aside class=search-results id=search><div class=container><section class=search-header><div class="row no-gutters justify-content-between mb-3"><div class=col-6><h1>Search</h1></div><div class="col-6 col-search-close"><a class=js-search href=#><i class="fas fa-times-circle text-muted" aria-hidden=true></i></a></div></div><div id=search-box><input name=q id=search-query placeholder=Search... autocapitalize=off autocomplete=off autocorrect=off spellcheck=false type=search></div></section><section class=section-search-results><div id=search-hits></div></section></div></aside><nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id=navbar-main><div class=container><div class="d-none d-lg-inline-flex"><a class=navbar-brand href=/>mjt</a></div><button type=button class=navbar-toggler data-toggle=collapse data-target=#navbar-content aria-controls=navbar aria-expanded=false aria-label="Toggle navigation">
<span><i class="fas fa-bars"></i></span></button><div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none"><a class=navbar-brand href=/>mjt</a></div><div class="navbar-collapse main-menu-item collapse justify-content-start" id=navbar-content><ul class="navbar-nav d-md-inline-flex"><li class=nav-item><a class=nav-link href=/#about><span>Home</span></a></li><li class=nav-item><a class=nav-link href=/#posts><span>Posts</span></a></li><li class=nav-item><a class=nav-link href=/#projects><span>Projects</span></a></li><li class=nav-item><a class=nav-link href=/#courses><span>Courses</span></a></li><li class=nav-item><a class=nav-link href=/#talks><span>Talks</span></a></li><li class=nav-item><a class=nav-link href=/#publications><span>Publications</span></a></li><li class=nav-item><a class=nav-link href=/#contact><span>Contact</span></a></li><li class=nav-item><a class=nav-link href=https://data-exp-lab.github.io/ target=_blank rel=noopener><span>Research Group</span></a></li></ul></div><ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2"><li class=nav-item><a class="nav-link js-search" href=# aria-label=Search><i class="fas fa-search" aria-hidden=true></i></a></li></ul></div></nav><article class=article><div class="article-container pt-3"><h1>Refactoring yt Frontends - Part 3</h1><div class=article-metadata><span class=article-date>Last updated on
Jun 17, 2019</span></div><div class="btn-links mb-3"><a class="btn btn-outline-primary my-1 mr-1" href=/project/yt/>Project</a></div></div><div class=article-container><div class=article-style><p>Welcome to part 3 of a series on how yt deals with data and the ways that helps and hinders things! This time, I am going to describe what &ldquo;chunks&rdquo; of data (<code>YTDataChunk</code>) in yt are, and a few characteristics of them that wouldn&rsquo;t be obvious from the previous blog posts.</p><h3 id=chunks-have-spatial-attributes>Chunks have spatial attributes</h3><p>Data chunks in yt have a set of special attributes that help yt to put them in the context of the coordinate domain.</p><p>(This is as good a time as any to note to myself that I should probably write up a blog post about how coordinate handling works, as opposed to index handling.)</p><p>When you receive a chunk of a data object, that chunk will have with it information about the coordinate space of the data contained within it &ndash; specifically, if it is a dataset that is volumetrically discretized in some regular way, it will have information about the centers of the individual grid cells, the sizes of those cells, and some measure of their resolution.</p><p>For a grid dataset specifically, these attributes will always exist on a data chunk:</p><ul><li><code>fcoords</code> - the centers of the grid cells, of shape <code>(..., 3)</code></li><li><code>fwidth</code> - the &ldquo;width&rdquo; of the grid cells, of shape <code>(..., 3)</code></li><li><code>icoords</code> - the <em>integer</em> coordinates, with respect to the <em>current</em> resolution, of the grid cells, of shape <code>(..., 3)</code></li><li><code>ires</code> - the &ldquo;level of resolution&rdquo; of a given cell; this mostly makes sense for datasets where there is some universal refinement ratio and a fixed value for the domain dimensions, of shape <code>(...,)</code></li></ul><p>There are a couple more that are specific to the individual data selection operation &ndash; for instance, <code>tcoords</code> only makes sense if there is a parameterized vector being pushed through the domain. There&rsquo;s also <code>fcoords_vertex</code> but it is seldom used except in unstructured mesh datasets.</p><p>Let&rsquo;s take a look at these values, and how they correspond to grid attributes:</p><pre><code class=language-python>import yt
ds = yt.load(&quot;data/IsolatedGalaxy/galaxy0030/galaxy0030&quot;)
</code></pre><pre><code>/home/matthewturk/conda-py3/lib/python3.7/importlib/_bootstrap.py:219: RuntimeWarning: numpy.dtype size changed, may indicate binary incompatibility. Expected 88 from C header, got 96 from PyObject
  return f(*args, **kwds)
yt : [INFO     ] 2019-06-17 22:23:02,723 Parameters: current_time              = 0.0060000200028298
yt : [INFO     ] 2019-06-17 22:23:02,724 Parameters: domain_dimensions         = [32 32 32]
yt : [INFO     ] 2019-06-17 22:23:02,726 Parameters: domain_left_edge          = [0. 0. 0.]
yt : [INFO     ] 2019-06-17 22:23:02,728 Parameters: domain_right_edge         = [1. 1. 1.]
yt : [INFO     ] 2019-06-17 22:23:02,734 Parameters: cosmological_simulation   = 0.0
</code></pre><p>What yt is doing here is taking an individual, in-memory <em>sparse</em> index and then <em>expanding</em> that index into a fully-fledged array. Internally, when we ask for any of these attributes, yt iterates over all the objects that belong in a given chunk and then it expands the values associated with those objects.</p><p>We can see this if we poke a little closer at the <code>Grid</code> objects in this case.</p><pre><code class=language-python>for g in ds.index.grids:
    pass
</code></pre><pre><code>Parsing Hierarchy : 100%|██████████| 173/173 [00:00&lt;00:00, 3064.43it/s]
yt : [INFO     ] 2019-06-17 22:23:02,831 Gathering a field list (this may take a moment.)
</code></pre><p>This is used internally in yt whenever we want to deal with a geometric selection, or when we apply geometric processing. For instance, the &ldquo;projection&rdquo; operator can use the integer coordinate system to very rapidly insert values into a
<a href=https://en.wikipedia.org/wiki/Quadtree target=_blank rel=noopener>quadtree</a>. yt can iterate over all of the chunks that belong to a data object and insert them into the quadtree based on their <code>icoords</code>, and it can refine nodes by bit shifting the appropriate amount.</p><p>For grid data, <code>icoords</code> also gives us some handy things for evaluating relationships between objects. For instance, we might have a root grid with one child grid. We can figure out their relationship by looking at their <code>icoords</code>, <code>ires</code> and the result of <code>get_global_startindex()</code>. In our sample dataset, let&rsquo;s look at some random grid &ndash; I happen to know the first level 8 grid is index 27, so let&rsquo;s use that.</p><pre><code class=language-python>child = ds.index.grids[27]
parent = child.Parent
</code></pre><pre><code class=language-python>parent.icoords
</code></pre><pre><code>array([[2048, 2048, 2048],
       [2048, 2048, 2049],
       [2048, 2048, 2050],
       ...,
       [2087, 2089, 2069],
       [2087, 2089, 2070],
       [2087, 2089, 2071]])
</code></pre><pre><code class=language-python>child.icoords
</code></pre><pre><code>array([[4096, 4096, 4096],
       [4096, 4096, 4097],
       [4096, 4096, 4098],
       ...,
       [4133, 4129, 4119],
       [4133, 4129, 4120],
       [4133, 4129, 4121]])
</code></pre><pre><code class=language-python>parent.LeftEdge, child.LeftEdge
</code></pre><pre><code>(YTArray([0.5, 0.5, 0.5]) code_length, YTArray([0.5, 0.5, 0.5]) code_length)
</code></pre><p>They both start at the same place &ndash; so that would suggest that their minimum icoords should refer to the same location.</p><pre><code class=language-python>difference = child.ires.min() - parent.ires.max()
left_edge_child = child.icoords.min(axis=0)
left_edge_parent = parent.icoords.min(axis=0)
(left_edge_child - left_edge_parent)
</code></pre><pre><code>array([2048, 2048, 2048])
</code></pre><p>This seems odd until we recognize that <code>ires</code> differs between the two, and in this case refers to the bit shifting we need to do to match them up.</p><pre><code class=language-python>(left_edge_child &gt;&gt; difference) - left_edge_parent
</code></pre><pre><code>array([0, 0, 0])
</code></pre><p>We can do this with the next grid up, as well.</p><pre><code class=language-python>left_edge_gparent = parent.Parent.icoords.min(axis=0)
difference_g = child.ires.min() - parent.Parent.ires.max()
(left_edge_child &gt;&gt; difference_g) - left_edge_gparent
</code></pre><pre><code>array([0, 0, 0])
</code></pre><p>There&rsquo;s more to this story &ndash; for instance, non-power-of-two differences, but the idea is consistent; both integer and float positioning can be used between chunks, sub-chunks, and so on.</p><p>We can also pretty easily get cell positions, and if we access data objects, we receive all the values across all sub-objects.</p><pre><code class=language-python>sp = ds.sphere(&quot;c&quot;, 0.1)
print(sp.fwidth)
</code></pre><pre><code>[[0.00024414 0.00024414 0.00024414]
 [0.00024414 0.00024414 0.00024414]
 [0.00024414 0.00024414 0.00024414]
 ...
 [0.00012207 0.00012207 0.00012207]
 [0.00012207 0.00012207 0.00012207]
 [0.00012207 0.00012207 0.00012207]] code_length
</code></pre><h3 id=chunks-can-be-sub-chunked>Chunks can be sub-chunked</h3><p>The other main advantage of chunks is that they can be sub-chunked. Usually this only means up to one level, but it means that we could in principle do something like this:</p><pre><code class=language-python>dd = ds.all_data()
for i, chunk1 in enumerate(dd.chunks([], &quot;io&quot;)):
    print(&quot;Chunk &quot;, i, len(chunk1._current_chunk.objs))
    print(&quot;      &quot;, end = &quot;&quot;)
    for j, chunk2 in enumerate(dd.chunks([], &quot;spatial&quot;)):
        print(chunk2._current_chunk.objs, end = &quot; &quot;)
    print()
    print()
</code></pre><pre><code>Chunk  0 5
      [EnzoGrid_0001] [EnzoGrid_0075] [EnzoGrid_0076] [EnzoGrid_0082] [EnzoGrid_0110] 

Chunk  1 1
      [EnzoGrid_0073] 

Chunk  2 20
      [EnzoGrid_0009] [EnzoGrid_0010] [EnzoGrid_0011] [EnzoGrid_0012] [EnzoGrid_0013] [EnzoGrid_0014] [EnzoGrid_0015] [EnzoGrid_0016] [EnzoGrid_0017] [EnzoGrid_0018] [EnzoGrid_0019] [EnzoGrid_0020] [EnzoGrid_0021] [EnzoGrid_0022] [EnzoGrid_0023] [EnzoGrid_0024] [EnzoGrid_0025] [EnzoGrid_0026] [EnzoGrid_0027] [EnzoGrid_0028] 

Chunk  3 28
      [EnzoGrid_0008] [EnzoGrid_0029] [EnzoGrid_0030] [EnzoGrid_0031] [EnzoGrid_0032] [EnzoGrid_0033] [EnzoGrid_0034] [EnzoGrid_0035] [EnzoGrid_0036] [EnzoGrid_0037] [EnzoGrid_0038] [EnzoGrid_0039] [EnzoGrid_0040] [EnzoGrid_0041] [EnzoGrid_0042] [EnzoGrid_0043] [EnzoGrid_0044] [EnzoGrid_0045] [EnzoGrid_0046] [EnzoGrid_0047] [EnzoGrid_0048] [EnzoGrid_0049] [EnzoGrid_0050] [EnzoGrid_0051] [EnzoGrid_0052] [EnzoGrid_0053] [EnzoGrid_0054] [EnzoGrid_0055] 

Chunk  4 20
      [EnzoGrid_0007] [EnzoGrid_0056] [EnzoGrid_0057] [EnzoGrid_0058] [EnzoGrid_0059] [EnzoGrid_0060] [EnzoGrid_0061] [EnzoGrid_0062] [EnzoGrid_0063] [EnzoGrid_0064] [EnzoGrid_0065] [EnzoGrid_0066] [EnzoGrid_0067] [EnzoGrid_0068] [EnzoGrid_0069] [EnzoGrid_0070] [EnzoGrid_0071] [EnzoGrid_0072] [EnzoGrid_0074] [EnzoGrid_0077] 

Chunk  5 16
      [EnzoGrid_0006] [EnzoGrid_0078] [EnzoGrid_0079] [EnzoGrid_0080] [EnzoGrid_0081] [EnzoGrid_0083] [EnzoGrid_0084] [EnzoGrid_0085] [EnzoGrid_0086] [EnzoGrid_0087] [EnzoGrid_0088] [EnzoGrid_0089] [EnzoGrid_0090] [EnzoGrid_0091] [EnzoGrid_0092] [EnzoGrid_0093] 

Chunk  6 13
      [EnzoGrid_0005] [EnzoGrid_0094] [EnzoGrid_0095] [EnzoGrid_0096] [EnzoGrid_0097] [EnzoGrid_0098] [EnzoGrid_0099] [EnzoGrid_0100] [EnzoGrid_0101] [EnzoGrid_0102] [EnzoGrid_0103] [EnzoGrid_0104] [EnzoGrid_0105] 

Chunk  7 14
      [EnzoGrid_0004] [EnzoGrid_0106] [EnzoGrid_0107] [EnzoGrid_0108] [EnzoGrid_0109] [EnzoGrid_0111] [EnzoGrid_0112] [EnzoGrid_0113] [EnzoGrid_0114] [EnzoGrid_0115] [EnzoGrid_0116] [EnzoGrid_0117] [EnzoGrid_0118] [EnzoGrid_0119] 

Chunk  8 26
      [EnzoGrid_0003] [EnzoGrid_0120] [EnzoGrid_0121] [EnzoGrid_0122] [EnzoGrid_0123] [EnzoGrid_0124] [EnzoGrid_0125] [EnzoGrid_0126] [EnzoGrid_0127] [EnzoGrid_0128] [EnzoGrid_0129] [EnzoGrid_0130] [EnzoGrid_0131] [EnzoGrid_0132] [EnzoGrid_0133] [EnzoGrid_0134] [EnzoGrid_0135] [EnzoGrid_0136] [EnzoGrid_0137] [EnzoGrid_0138] [EnzoGrid_0139] [EnzoGrid_0140] [EnzoGrid_0141] [EnzoGrid_0142] [EnzoGrid_0143] [EnzoGrid_0144] 

Chunk  9 30
      [EnzoGrid_0002] [EnzoGrid_0145] [EnzoGrid_0146] [EnzoGrid_0147] [EnzoGrid_0148] [EnzoGrid_0149] [EnzoGrid_0150] [EnzoGrid_0151] [EnzoGrid_0152] [EnzoGrid_0153] [EnzoGrid_0154] [EnzoGrid_0155] [EnzoGrid_0156] [EnzoGrid_0157] [EnzoGrid_0158] [EnzoGrid_0159] [EnzoGrid_0160] [EnzoGrid_0161] [EnzoGrid_0162] [EnzoGrid_0163] [EnzoGrid_0164] [EnzoGrid_0165] [EnzoGrid_0166] [EnzoGrid_0167] [EnzoGrid_0168] [EnzoGrid_0169] [EnzoGrid_0170] [EnzoGrid_0171] [EnzoGrid_0172] [EnzoGrid_0173] 
</code></pre><p>(In general, this is about as deep as it goes, although in principle we could do lots more sub-chunking.) This lets you chunk over IO, then chunk over individual objects, and even request things like the number of ghost zones you need in that sub-chunking.</p><h3 id=chunks-can-retain-state-during-a-long-lived-io-task>Chunks can retain state during a long-lived IO task</h3><p>We can also store field parameters and reset them during an individual chunking operation. So for instance, we could have a custom field that requires one field parameter that is then swapped out during the next level of chunking.</p><p>This feature is probably not used much.</p><h2 id=iteration-and-chunks>Iteration and Chunks</h2><p>But here&rsquo;s the issue we run into, which actually shows up whenever an error is raised during a chunking operation.</p><p><strong>All of this is done via generator expressions.</strong> This seemed like the right thing to do! Just <code>yield</code> everywhere! It was so hip.</p><p>But, there&rsquo;s an even more problematic part: <strong>often, the generator expressions get unrolled into lists anyway.</strong> And, it turns out, I can&rsquo;t blame anybody else for this: this particular core element of yt was something I not only put in, but something I felt rather self-satisfied about.</p><p>Let&rsquo;s take a look at this in the routine that does chunking for the <code>io</code> type in grid index datasets:</p><pre><code class=language-python>ds.index._chunk_io??
</code></pre><pre><code>Signature:
ds.index._chunk_io(
    dobj,
    cache=True,
    local_only=False,
    preload_fields=None,
    chunk_sizing='auto',
)
Docstring: &lt;no docstring&gt;
Source:   
    def _chunk_io(self, dobj, cache=True, local_only=False,
                  preload_fields=None, chunk_sizing=&quot;auto&quot;):
        # local_only is only useful for inline datasets and requires
        # implementation by subclasses.
        if preload_fields is None:
            preload_fields = []
        preload_fields, _ = self._split_fields(preload_fields)
        gfiles = defaultdict(list)
        gobjs = getattr(dobj._current_chunk, &quot;objs&quot;, dobj._chunk_info)
        fast_index = dobj._current_chunk._fast_index
        for g in gobjs:
            # Force to be a string because sometimes g.filename is None.
            gfiles[str(g.filename)].append(g)
        # We can apply a heuristic here to make sure we aren't loading too
        # many grids all at once.
        if chunk_sizing == &quot;auto&quot;:
            chunk_ngrids = len(gobjs)
            if chunk_ngrids &gt; 0:
                nproc = np.float(ytcfg.getint(&quot;yt&quot;, &quot;__global_parallel_size&quot;))
                chunking_factor = np.ceil(self._grid_chunksize*nproc/chunk_ngrids).astype(&quot;int&quot;)
                size = max(self._grid_chunksize//chunking_factor, 1)
            else:
                size = self._grid_chunksize
        elif chunk_sizing == &quot;config_file&quot;:
            size = ytcfg.getint(&quot;yt&quot;, &quot;chunk_size&quot;)
        elif chunk_sizing == &quot;just_one&quot;:
            size = 1
        elif chunk_sizing == &quot;old&quot;:
            size = self._grid_chunksize
        else:
            raise RuntimeError(&quot;%s is an invalid value for the 'chunk_sizing' argument.&quot; % chunk_sizing)
        for fn in sorted(gfiles):
            gs = gfiles[fn]
            for grids in (gs[pos:pos + size] for pos
                          in range(0, len(gs), size)):
                dc = YTDataChunk(dobj, &quot;io&quot;, grids,
                        self._count_selection(dobj, grids),
                        cache = cache, fast_index = fast_index)
                # We allow four full chunks to be included.
                with self.io.preload(dc, preload_fields, 
                            4.0 * size):
                    yield dc
File:      ~/yt/yt/yt/geometry/grid_geometry_handler.py
Type:      method
</code></pre><p>There&rsquo;s lots going on here, so I&rsquo;ll just grab a few of the most important lines. Specifically, I want to highlight this:</p><pre><code class=language-python>        for fn in sorted(gfiles):
            gs = gfiles[fn]
            for grids in (gs[pos:pos + size] for pos
                          in range(0, len(gs), size)):
                dc = YTDataChunk(dobj, &quot;io&quot;, grids,
                        self._count_selection(dobj, grids),
                        cache = cache, fast_index = fast_index)
                # We allow four full chunks to be included.
                with self.io.preload(dc, preload_fields, 
                            4.0 * size):
                    yield dc
</code></pre><p>The upshot of this is that we first sorted our grids by which file they&rsquo;re in (on the assumption that we probably want to minimize open/close operations), but then in that, we split them up based on the grid counts we want in each chunk, and then we spit out the chunks (with optional preloading of data) to whatever consumes them.</p><p>As long as we don&rsquo;t do any preloading it&rsquo;s alright for parallel IO, but we&rsquo;re not going to see any of the benefits of this if we ever turn this into a list.</p><p>Now for the Enzo frontend specifically, let&rsquo;s see how the IO routine works:</p><pre><code class=language-python>ds.index.io._read_fluid_selection??
</code></pre><pre><code>Signature: ds.index.io._read_fluid_selection(chunks, selector, fields, size)
Docstring: &lt;no docstring&gt;
Source:   
    def _read_fluid_selection(self, chunks, selector, fields, size):
        # This function has an interesting history.  It previously was mandate
        # to be defined by all of the subclasses.  But, to avoid having to
        # rewrite a whole bunch of IO handlers all at once, and to allow a
        # better abstraction for grid-based frontends, we're now defining it in
        # the base class.
        rv = {}
        nodal_fields = []
        for field in fields:
            finfo = self.ds.field_info[field]
            nodal_flag = finfo.nodal_flag
            if np.any(nodal_flag):
                num_nodes = 2**sum(nodal_flag)
                rv[field] = np.empty((size, num_nodes), dtype=&quot;=f8&quot;)
                nodal_fields.append(field)
            else:
                rv[field] = np.empty(size, dtype=&quot;=f8&quot;)
        ind = {field: 0 for field in fields}
        for field, obj, data in self.io_iter(chunks, fields):
            if data is None:
                continue
            if isinstance(selector, GridSelector) and field not in nodal_fields:
                ind[field] += data.size
                rv[field] = data.copy()
            else:
                ind[field] += obj.select(selector, data, rv[field], ind[field])
        return rv
File:      ~/yt/yt/yt/utilities/io_handler.py
Type:      method
</code></pre><p>This is in the base class for the IO handler; some of the grid-based frontends implement it. In this <em>particular</em> case we aren&rsquo;t unrolling the generator, but you can see some of the issues here anyway: we need to know a fair bit about the IO method (thus the <code>io_iter</code> method, which I will show below) and we need to do a lot of <code>obj.select</code> and whatnot.</p><p>This isn&rsquo;t terribly efficient, and it <em>also</em> means that since we are yielding a generator expression from within a generator expression, we end up having a nested set of loops that don&rsquo;t know their sizes or allow seeking in their stream of yields.</p><p>This makes interoperating with something like dask &ndash; which works best when it knows the sizes and shapes and can do its own distribution &ndash; much more challenging. And it also means that we have a few layers of relatively opaque routines that conspire to keep us a ways from the file-based abstraction.</p><p>Let&rsquo;s look at the <code>io_iter</code> function to see how it works for Enzo. You can see that it does do a few fun things; most importantly, it keeps the file handle open if it can. This can save a surprising amount of time on parallel file systems, as it reduces the number of metadata lookups necessary.</p><pre><code class=language-python>ds.index.io.io_iter??
</code></pre><pre><code>Signature: ds.index.io.io_iter(chunks, fields)
Docstring: &lt;no docstring&gt;
Source:   
    def io_iter(self, chunks, fields):
        h5_dtype = self._field_dtype
        for chunk in chunks:
            fid = None
            filename = -1
            for obj in chunk.objs:
                if obj.filename is None: continue
                if obj.filename != filename:
                    # Note one really important thing here: even if we do
                    # implement LRU caching in the _read_obj_field function,
                    # we'll still be doing file opening and whatnot.  This is a
                    # problem, but one we can return to.
                    if fid is not None:
                        fid.close()
                    fid = h5py.h5f.open(b(obj.filename), h5py.h5f.ACC_RDONLY)
                    filename = obj.filename
                for field in fields:
                    nodal_flag = self.ds.field_info[field].nodal_flag
                    dims = obj.ActiveDimensions[::-1] + nodal_flag[::-1]
                    data = np.empty(dims, dtype=h5_dtype)
                    yield field, obj, self._read_obj_field(
                        obj, field, (fid, data))
        if fid is not None:
            fid.close()
File:      ~/yt/yt/yt/frontends/enzo/io.py
Type:      method
</code></pre><p>So to recap, right now: making chunks work nicely with non-yt operations is tricky because of some early design decisions</p><h2 id=next-up>Next Up</h2><p>In the next blog post, I&rsquo;m going to present a bit about:</p><ul><li>How particle IO is handled &ndash; and the differences between grid IO (which has lots of differently-<em>shaped</em> chunks) and particle IO</li><li>Some efforts to refactor particle IO (before it gets released!)</li><li>A future for how to make all this stuff work better with dask (yes, really, I promise)</li></ul></div><div class="media author-card content-widget-hr"><img class="avatar mr-3 avatar-circle" src="https://s.gravatar.com/avatar/b279d746f54e2cd6062e8279a767c4bc?s=200')" alt="Matthew Turk"><div class=media-body><h5 class=card-title><a href=https://matthewturk.github.io/>Matthew Turk</a></h5><h6 class=card-subtitle>Assistant Professor of Information Sciences</h6><p class=card-text>I am interested in the intersection of data analysis, visualization and open source in the sciences.</p><ul class=network-icon aria-hidden=true><li><a href=mailto:matthewturk@gmail.com><i class="fas fa-envelope"></i></a></li><li><a href=https://twitter.com/powersoffour target=_blank rel=noopener><i class="fab fa-twitter"></i></a></li><li><a href="https://scholar.google.com/citations?user=QTmv2p0AAAAJ&hl=en" target=_blank rel=noopener><i class="ai ai-google-scholar"></i></a></li><li><a href=https://github.com/matthewturk target=_blank rel=noopener><i class="fab fa-github"></i></a></li></ul></div></div></div></article><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/languages/python.min.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.5.1/leaflet.js integrity="sha256-EErZamuLefUnbMBQbsEqu1USa+btR2oIlCpBJbyD4/g=" crossorigin=anonymous></script><script>const code_highlighting=true;</script><script>const isSiteThemeDark=false;</script><script>const search_config={"indexURI":"/index.json","minLength":1,"threshold":0.3};const i18n={"no_results":"No results found","placeholder":"Search...","results":"results found"};const content_type={'post':"Posts",'project':"Projects",'publication':"Publications",'talk':"Talks",'slides':"Slides"};</script><script id=search-hit-fuse-template type=text/x-template>
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script><script src=https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin=anonymous></script><script src=https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin=anonymous></script><script src=/js/academic.min.37431be2d92d7fb0160054761ab79602.js></script><div class=container><footer class=site-footer><p class=powered-by></p><p class=powered-by>Powered by the
<a href=https://sourcethemes.com/academic/ target=_blank rel=noopener>Academic theme</a> for
<a href=https://gohugo.io target=_blank rel=noopener>Hugo</a>.
<span class=float-right aria-hidden=true><a href=# class=back-to-top><span class=button_icon><i class="fas fa-chevron-up fa-2x"></i></span></a></span></p></footer></div><div id=modal class="modal fade" role=dialog><div class=modal-dialog><div class=modal-content><div class=modal-header><h5 class=modal-title>Cite</h5><button type=button class=close data-dismiss=modal aria-label=Close>
<span aria-hidden=true>&#215;</span></button></div><div class=modal-body><pre><code class="tex hljs"></code></pre></div><div class=modal-footer><a class="btn btn-outline-primary my-1 js-copy-cite" href=# target=_blank><i class="fas fa-copy"></i>Copy</a>
<a class="btn btn-outline-primary my-1 js-download-cite" href=# target=_blank><i class="fas fa-download"></i>Download</a><div id=modal-error></div></div></div></div></div></body></html>